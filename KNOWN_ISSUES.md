# 未解決のアーキテクチャ課題と制限事項 (Known Issues)

OpenClawとGemini CLIを接続する本アダプタ (`gemini-cli-claw`) において、現状の設計上、完全には引き出せていないOpenClaw本来の機能や、長期運用・自律稼働において致命的となり得る3つのクリティカルな課題をここに記録します。

## ✅ 1. 実行の同期的ロックとタイムアウト問題（**解決済み**）

**対象モジュール:** ~~`adapter.js`~~ → `src/server.js`, `src/streaming.js`, `src/runner-pool.js`

旧実装では Gemini CLI を呼び出す際に Node.js の `spawnSync`（同期実行処理）を用いていましたが、現在は非同期ストリーミング・ Runner Pool 方式に完全移行しました。

*   **同期ロックの解消**: OpenClaw 側に出力を即時ストリームするリアルタイム SSE 実装（`src/streaming.js` + `src/runner-pool.js`）により解決。
*   **タイムアウト問題の解消**: Abort 機能（`res.on('close')` フック → `SIGTERM`/`SIGKILL`）の実装により解決。クライアントが `/stop` で切断されると、Gemini CLI プロセスが即座に安全に破棄される。

## ✅ 2. コンテキスト剪定（Pruning）の完全な乖離（**解決済み**）

**対象モジュール:** `src/server.js`, `src/session.js`

過去のアーキテクチャでは、Gemini CLI の `--resume <セッションID>` フラグを利用して対話を継続していたため、トークン管理をGeminiの内部データベースに依存し、OpenClaw側のコンテキスト剪定（Pruning）が反映されないという致命的な問題がありました。

*   **完全なプロキシ化による解決**: 現在は `--resume` によるGemini側での履歴の自動継続を廃止しました。
*   **ステートレスな直接注入**: 毎ターン、OpenClawによって最適に計算・剪定された履歴（`messages`）を受け取り、アダプター側で `resumedSessionData` 構造体に変換。Runner Pool を通じて直接 Gemini CLI プロセスのメモリに注入する「操り人形化（完全なプロキシ化）」を実現したため、このトークン上限突破問題は根本から解決しています。

## 3. MCPツールの途中経過（Stream/onUpdate）とキャンセルの喪失

**対象モジュール:** `mcp-server.mjs`

OpenClawのネイティブツール機能は、「長時間の実行中に、今何をしているかの進捗やログを `onUpdate` コールバックでリアルタイムに返す」能力や、「不要になった処理を `AbortSignal` で強制中断する」能力を備えています。

*   **影響:**
    `mcp-server.mjs` の現在のディスパッチ実装（137行目付近）では、元ツールから送られてくる `onUpdate` の進捗ログを、単なる `console.error` として虚空（Gemini CLIの不可視領域）に捨ててしまっています。
*   **致命的リスク:**
    Gemini側からは、ツールが延々と無言で動いているようにしか見えず、「途中のエラーログに気づいて自らリカバリー操作を行う」といった高度な自律的判断ができません。また、キャンセルのシグナルを送る機構も未実装なため、ツールが暴走した場合の中断も不可能です。
*   **解決方針案:**
    Model Context Protocol (MCP) の仕様に沿って、進行中状況を通知するストリーム機能の実装、またはエラーや途中経過を段階的に返すイベントフックの構築が必要です。
    > **【検証結果 (2024/02時点)】**
    > 実際に `mcp-server.mjs` にて `_meta.progressToken` を検知して `notifications/progress` を返す実装をテストしましたが、**現在の Gemini CLI は MCPツール呼び出し時に `progressToken` を一切送信しない（進捗管理プロトコルに未対応である）** ことが判明しました。そのため、この問題の根本解決には「Gemini CLI本体側のアップデート」または「途中経過を別ツール（中間ファイル等）経由で手動ポーリングさせる特殊なプロンプト設計」を待つ必要があります。
